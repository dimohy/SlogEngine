@using SlogEngine.WebAssembly.Models
@using SlogEngine.WebAssembly.Services
@inject IImageService ImageService
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<Modal Title="@ModalTitle" ShowActions="true" ConfirmText="@ConfirmButtonText" OnClose="CancelEdit" OnConfirm="SavePost">
    <ChildContent>
        <EditForm Model="@editingPost">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group">
                <label for="edit-title">제목</label>
                <InputText id="edit-title" @bind-Value="editingPost!.Title" class="form-control" placeholder="포스트 제목을 입력하세요" />
            </div>

            <div class="form-group">
                <label for="edit-summary">요약</label>
                <InputTextArea id="edit-summary" @bind-Value="editingPost!.Summary" class="form-control" rows="4" placeholder="포스트 요약을 입력하세요" />
            </div>

            <div class="form-group">
                <label for="edit-content">내용</label>
                <InputTextArea @ref="contentTextArea" id="edit-content" @bind-Value="editingPost!.Content" class="form-control" rows="12" placeholder="포스트 내용을 마크다운으로 작성하세요. 이미지는 Ctrl+V로 붙여넣기 가능합니다." />
                @if (isUploadingImage)
                {
                    <div class="image-upload-progress">
                        <small class="text-info">이미지 업로드 중...</small>
                    </div>
                }
            </div>
        </EditForm>
    </ChildContent>
</Modal>

@code {
    [Parameter] public BlogPost? editingPost { get; set; }
    [Parameter] public EventCallback<BlogPost> OnUpdate { get; set; }
    [Parameter] public EventCallback<BlogPost> OnAdd { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public bool IsNewPost { get; set; } = false;

    private string ModalTitle => IsNewPost ? "새 포스트 추가" : "포스트 수정";
    private string ConfirmButtonText => IsNewPost ? "추가" : "저장";
    private bool isUploadingImage = false;
    private DotNetObjectReference<EditPostModal>? dotNetHelper;
    private InputTextArea? contentTextArea;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                dotNetHelper = DotNetObjectReference.Create(this);
                
                // DOM이 완전히 로드될 때까지 약간 대기
                await Task.Delay(100);
                
                await JSRuntime.InvokeVoidAsync("clipboardHelper.addPasteListener", "edit-content", dotNetHelper);
                Console.WriteLine("클립보드 리스너가 성공적으로 등록되었습니다.");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"클립보드 리스너 등록 실패: {ex.Message}");
            }
        }
    }

    [JSInvokable]
    public async Task OnImagePasted(string base64Data, string fileName, string mimeType)
    {
        try
        {
            Console.WriteLine($"이미지 붙여넣기 시작: {fileName}, MIME: {mimeType}, Base64 길이: {base64Data.Length}");
            
            isUploadingImage = true;
            StateHasChanged();

            // 임시 마크다운 텍스트 생성 및 삽입
            var timestamp = DateTime.Now.ToString("HHmmss");
            var placeholder = $"![업로드 중...](uploading_{timestamp})";
            
            await JSRuntime.InvokeVoidAsync("clipboardHelper.insertTextAtCursor", "edit-content", placeholder);
            Console.WriteLine("임시 placeholder 삽입 완료");

            // Base64를 바이트 배열로 변환
            var imageData = Convert.FromBase64String(base64Data);
            Console.WriteLine($"Base64 디코딩 완료: {imageData.Length} bytes");

            // 이미지 업로드
            using var imageStream = new MemoryStream(imageData);
            var imageUrl = await ImageService.UploadImageAsync("dimohy", imageStream, fileName); // TODO: 실제 사용자명으로 변경
            Console.WriteLine($"이미지 업로드 완료: {imageUrl}");

            // placeholder를 실제 URL로 교체
            if (editingPost != null && !string.IsNullOrEmpty(editingPost.Content))
            {
                var altText = Path.GetFileNameWithoutExtension(fileName);
                var newImageMarkdown = $"![{altText}]({imageUrl})";
                
                editingPost.Content = editingPost.Content.Replace(placeholder, newImageMarkdown);
                Console.WriteLine("이미지 마크다운 교체 완료");
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"이미지 업로드 오류: {ex.Message}");
            
            // 오류 발생 시 placeholder 제거
            if (editingPost != null && !string.IsNullOrEmpty(editingPost.Content))
            {
                var timestamp = DateTime.Now.ToString("HHmmss");
                var placeholder = $"![업로드 중...](uploading_{timestamp})";
                editingPost.Content = editingPost.Content.Replace(placeholder, "");
                StateHasChanged();
            }
            
            // TODO: 사용자에게 오류 메시지 표시
        }
        finally
        {
            isUploadingImage = false;
            StateHasChanged();
        }
    }

    private async Task SavePost()
    {
        if (editingPost != null)
        {
            if (IsNewPost)
            {
                Console.WriteLine($"EditPostModal.SavePost: Adding new post with title: {editingPost.Title}");
                await OnAdd.InvokeAsync(editingPost);
            }
            else
            {
                Console.WriteLine($"EditPostModal.SavePost: Updating post {editingPost.Id} with title: {editingPost.Title}");
                await OnUpdate.InvokeAsync(editingPost);
            }
        }
        else
        {
            Console.WriteLine("EditPostModal.SavePost: editingPost is null");
        }
    }

    private async Task CancelEdit()
    {
        await OnCancel.InvokeAsync();
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (dotNetHelper != null)
            {
                await JSRuntime.InvokeVoidAsync("clipboardHelper.removePasteListener", "edit-content");
                dotNetHelper.Dispose();
                Console.WriteLine("클립보드 리스너가 성공적으로 제거되었습니다.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"클립보드 리스너 제거 중 오류: {ex.Message}");
        }
    }
}
